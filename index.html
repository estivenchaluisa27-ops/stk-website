<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Sistema de Gestión de Turnos - Laboratorio de Redes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos base, fuentes e interactividad mejorados */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05); padding: 1.5rem; }
        
        /* Cuadrícula de 6 columnas: 1 para Hora + 5 para Días (Lun-Vie) */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: 1.5fr repeat(5, 1fr); /* Columna de hora más ancha */
            gap: 4px; 
            font-size: 0.8rem;
        }
        .time-slot { 
            padding: 0.5rem; 
            text-align: center; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            height: 60px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            line-height: 1.2;
            border: 1px solid transparent; /* Borde base para consistencia */
        }
        
        /* Estilos de Slots base */
        .slot-header { 
            font-weight: bold; 
            background-color: #e5e7eb; 
            padding: 0.5rem; 
            border-radius: 0.5rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 60px;
        }
        .slot-disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        .slot-free { background-color: #d1fae5; color: #065f46; border-color: #a7f3d0; }
        .slot-free:hover { background-color: #a7f3d0; }
        
        /* Estilo de Selección Múltiple (para Admin y Estudiante) */
        .slot-selected { 
            background-color: #3b82f6 !important; /* Usar important para sobreescribir colores de grupo */
            color: white !important; 
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.5); 
            transform: scale(1.03); 
            border-color: #3b82f6 !important;
        }
        
        /* Estilos de Botones */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; box-shadow: none; }
        
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }

        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }


        /* Clases de Color de Grupo (Generadas por JS) */
        /* Ejemplo: .bg-red-200, .text-red-800, .border-red-300 */
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal -->
    <div id="app-container" class="w-full max-w-6xl"> <!-- Aumentado a max-w-6xl -->

        <!-- Vista de Login -->
        <div id="login-view" class="card max-w-lg mx-auto">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Acceso al Sistema de Turnos</h1>
            
            <div id="message-box" class="mb-4 hidden p-3 rounded-lg text-sm" role="alert"></div>

            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="login-email" placeholder="Correo Electrónico (ej: lider1@uni.edu)" class="w-full border p-3 rounded-lg" required>
                <input type="password" id="login-password" placeholder="Contraseña (ej: pass123)" class="w-full border p-3 rounded-lg" required>
                <button type="submit" class="btn btn-primary w-full mt-6 py-3">
                    Ingresar
                </button>
            </form>
        </div>

        <!-- Vista del Sistema -->
        <div id="system-view" class="hidden w-full">
            <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
                <h1 class="text-3xl font-bold text-gray-900">
                    Panel de <span id="user-display-role">Carga</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-gray-600">
                        <span id="user-display-group"></span> (<span id="user-display-email"></span>)
                    </span>
                    <button onclick="handleLogout()" class="text-red-600 hover:text-red-800 font-semibold transition duration-150">
                        Salir
                    </button>
                </div>
            </header>
            
            <!-- Contenido del Panel: Administrador (NUEVO LAYOUT DE 2 COLUMNAS) -->
            <div id="admin-panel" class="hidden card mt-4 grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Columna Izquierda: Calendario de Admin -->
                <div class="lg:col-span-2 space-y-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Gestión de Horario Semanal</h2>
                    <p class="text-sm text-gray-500">
                        Selecciona múltiples slots (Libres o Bloqueados) y usa los botones de acción.
                    </p>
                    
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeWeek(-1)" class="btn btn-secondary">
                            &lt; Semana Ant.
                        </button>
                        <span id="admin-week-display" class="font-bold text-lg text-gray-700 text-center w-48"></span>
                        <button onclick="changeWeek(1)" class="btn btn-secondary">
                            Semana Sig. &gt;
                        </button>
                    </div>

                    <!-- Barra de Acción Admin (NUEVA) -->
                    <div id="admin-action-box" class="p-4 bg-gray-100 rounded-lg flex gap-4 hidden">
                        <button id="admin-block-btn" onclick="adminSubmitBatch('blocked')" class="btn btn-danger w-full">Bloquear (0)</button>
                        <button id="admin-unblock-btn" onclick="adminSubmitBatch('unblock')" class="btn btn-secondary w-full">Desbloquear (0)</button>
                    </div>

                    <div class="card overflow-x-auto p-2 border">
                        <div id="admin-calendar" class="calendar-grid min-w-max">
                            <!-- Generado por JS -->
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Aprobaciones -->
                <div class="lg:col-span-1 space-y-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Solicitudes Pendientes</h2>
                    <div id="requests-list" class="space-y-4 max-h-[80vh] overflow-y-auto">
                        <p class="text-gray-500">Cargando solicitudes...</p>
                    </div>
                </div>

            </div>

            <!-- Contenido del Panel: Estudiante (Sin cambios de layout) -->
            <div id="student-panel" class="hidden mt-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Reservar Turno (Lun-Vie)</h2>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changeWeek(-1)" class="btn btn-secondary">
                            &lt; Semana Ant.
                        </button>
                        <span id="student-week-display" class="font-bold text-lg text-gray-700 text-center w-48"></span>
                        <button onclick="changeWeek(1)" class="btn btn-secondary">
                            Semana Sig. &gt;
                        </button>
                    </div>
                </div>

                <div class="card overflow-x-auto p-2 border">
                    <div id="student-calendar" class="calendar-grid min-w-max">
                        <!-- Generado por JS -->
                    </div>
                </div>

                <!-- LEYENDA DE ESTADOS -->
                <div id="student-legend" class="mt-6 card p-4">
                    <h4 class="text-lg font-semibold mb-3 text-center text-gray-700">Leyenda</h4>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 justify-center">
                        
                        <div class="flex items-center space-x-2">
                            <div class="w-5 h-5 rounded-md slot-free"></div>
                            <span class="text-sm text-gray-600">Libre</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <div class="w-5 h-5 rounded-md slot-selected"></div>
                            <span class="text-sm text-gray-600">Mi Selección</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <!-- Color genérico para Pendiente (basado en Grupo 2) -->
                            <div class="w-5 h-5 rounded-md bg-yellow-200 border border-yellow-300"></div>
                            <span class="text-sm text-gray-600">Pendiente</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <!-- Color genérico para Reservado (basado en Grupo 1) -->
                            <div class="w-5 h-5 rounded-md bg-red-500"></div>
                            <span class="text-sm text-gray-600">Reservado</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <!-- Color para Bloqueado/Pasado -->
                            <div class="w-5 h-5 rounded-md bg-gray-700"></div>
                            <span class="text-sm text-gray-600">No Disponible</span>
                        </div>

                    </div>
                </div>
                <!-- FIN DE LEYENDA -->

                <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-2 text-yellow-800">Solicitud de Turno</h3>
                    <p id="selected-slot-display" class="mb-4 text-gray-700">
                        Selecciona uno o más horarios libres en el calendario para solicitar un turno.
                    </p>
                    <button id="request-button" onclick="submitRequest()" class="btn btn-primary" disabled>
                        Enviar Solicitud (0 turnos)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS Y CONFIGURACIÓN ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged, 
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuración de la aplicación
        const appId = 'lab-redes-turnos'; 
        const firebaseConfig = {
            apiKey: "AIzaSyCR4Kk7kIBpSW3cF02b8zUHegvV4WQNuyI",
            authDomain: "lab-redes-turnos.firebaseapp.com",
            projectId: "lab-redes-turnos",
            storageBucket: "lab-redes-turnos.firebasestorage.app",
            messagingSenderId: "592544790067",
            appId: "1:592544790067:web:00bde37b50d3edf9f59546"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        setPersistence(auth, browserLocalPersistence);

        // Estado Global
        let userId = null;
        let userRole = null;
        let currentGroup = null; // <-- { name, color }
        let currentRepName = null;
        let reservations = []; 
        let authReady = false;
        let studentSelectedSlots = []; // <-- renombrado para claridad
        let adminSelectedSlots = []; // <-- NUEVO ESTADO PARA ADMIN
        let currentWeekOffset = 0; 
        
        // --- CONSTANTES DE AUTENTICACIÓN FIJAS (CON COLORES) ---
        const GRUPO_LIDERES = {
            "lider1@uni.edu": { name: "Grupo Redes A", color: "red" },
            "lider2@uni.edu": { name: "Grupo Redes B", color: "yellow" },
            "lider3@uni.edu": { name: "Grupo Control C", color: "green" },
            "lider4@uni.edu": { name: "Grupo Servidores D", color: "blue" },
            "lider5@uni.edu": { name: "Grupo Seguridad E", color: "indigo" },
            "lider6@uni.edu": { name: "Grupo Pruebas F", color: "purple" },
            "lider7@uni.edu": { name: "Grupo Final G", color: "pink" },
        };
        const LIDER_PASS = 'pass123'; 
        const ADMIN_CREDENTIALS = {
            "admin1@lab.edu": true,
            "admin2@lab.edu": true,
        };
        const ADMIN_PASS = 'adminpass'; 

        // --- CONSTANTES DEL CALENDARIO (7am - 7pm) ---
        const HOUR_SLOTS = [
            { label: '07:00 - 08:00', data: '07:00' },
            { label: '08:00 - 09:00', data: '08:00' },
            { label: '09:00 - 10:00', data: '09:00' },
            { label: '10:00 - 11:00', data: '10:00' },
            { label: '11:00 - 12:00', data: '11:00' },
            { label: '12:00 - 13:00', data: '12:00' },
            { label: '13:00 - 14:00', data: '13:00' },
            { label: '14:00 - 15:00', data: '14:00' },
            { label: '15:00 - 16:00', data: '15:00' },
            { label: '16:00 - 17:00', data: '16:00' },
            { label: '17:00 - 18:00', data: '17:00' },
            { label: '18:00 - 19:00', data: '18:00' },
            { label: '19:00 - 20:00', data: '19:00' } 
        ];
        
        // Rutas de la Base de Datos
        const COLLECTION_PATH = `artifacts/${appId}/public/data/reservations`;

        // --- UTILIDADES ---

        function showMessage(message, type) {
            const box = document.getElementById('message-box');
            if (!box) return; 
            box.innerText = message;
            box.className = 'mb-4 p-3 rounded-lg text-sm';
            box.classList.remove('hidden');
            const classMap = {
                'success': ['bg-green-100', 'text-green-800', 'border', 'border-green-400'],
                'error': ['bg-red-100', 'text-red-800', 'border', 'border-red-400'],
                'info': ['bg-blue-100', 'text-blue-800', 'border', 'border-blue-400'],
            };
            box.classList.add(...classMap[type]);
            setTimeout(() => box.classList.add('hidden'), 5000);
        }

        function hideMessage() {
            const box = document.getElementById('message-box');
            if (box) box.classList.add('hidden');
        }

        function formatReservationId(date, hour) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}_${hour.replace(':', '-')}`;
        }
        
        function getSlotColorClasses(colorName, status) {
            if (status === 'approved') {
                const colors = {
                    red: 'bg-red-500 text-white',
                    yellow: 'bg-yellow-500 text-white',
                    green: 'bg-green-500 text-white',
                    blue: 'bg-blue-500 text-white',
                    indigo: 'bg-indigo-500 text-white',
                    purple: 'bg-purple-500 text-white',
                    pink: 'bg-pink-500 text-white',
                    default: 'bg-gray-500 text-white'
                };
                return (colors[colorName] || colors.default).split(' ');
            } else {
                const colors = {
                    red: 'bg-red-200 text-red-800 border-red-300',
                    yellow: 'bg-yellow-200 text-yellow-800 border-yellow-300',
                    green: 'bg-green-200 text-green-800 border-green-300',
                    blue: 'bg-blue-200 text-blue-800 border-blue-300',
                    indigo: 'bg-indigo-200 text-indigo-800 border-indigo-300',
                    purple: 'bg-purple-200 text-purple-800 border-purple-300',
                    pink: 'bg-pink-200 text-pink-800 border-pink-300',
                    default: 'bg-gray-200 text-gray-800 border-gray-300'
                };
                return (colors[colorName] || colors.default).split(' ');
            }
        }


        // --- LÓGICA DE CALENDARIO ---

        function getWeekDays(offset) {
            const days = [];
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            today.setDate(today.getDate() + diff + (offset * 7));
            for (let i = 0; i < 5; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                days.push(date);
            }
            return days;
        }
        
        // --- MANEJO DE VISTAS Y AUTENTICACIÓN ---

        function renderSystemView() {
            // ... (código existente de renderSystemView, sin cambios) ...
            const loginView = document.getElementById('login-view');
            const systemView = document.getElementById('system-view');
            const adminPanel = document.getElementById('admin-panel');
            const studentPanel = document.getElementById('student-panel');
            
            loginView.classList.add('hidden');
            systemView.classList.remove('hidden');
            systemView.classList.add('flex', 'flex-col');
            
            document.getElementById('user-display-role').textContent = userRole === 'admin' ? 'Administración' : 'Jefe de Grupo';
            document.getElementById('user-display-group').textContent = currentGroup.name; 
            document.getElementById('user-display-email').textContent = auth.currentUser.email;

            if (userRole === 'admin') {
                adminPanel.classList.remove('hidden');
                studentPanel.classList.add('hidden');
                renderCalendar('admin-calendar', 'admin-week-display');
            } else {
                adminPanel.classList.add('hidden');
                studentPanel.classList.remove('hidden');
                renderCalendar('student-calendar', 'student-week-display');
            }
        }

        window.handleLogin = async (e) => {
            // ... (código existente de handleLogin, sin cambios) ...
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            await signOut(auth).catch(() => {}); // Limpiar sesión anterior si existe
            hideMessage(); 

            if (!email || !password) {
                showMessage("Por favor, introduce tu correo y contraseña.", 'error');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const authenticatedEmail = userCredential.user.email;

                if (ADMIN_CREDENTIALS[authenticatedEmail]) {
                    if (password !== ADMIN_PASS) {
                         await signOut(auth);
                         showMessage("Contraseña de Administrador incorrecta.", 'error');
                         return;
                    }
                    userRole = 'admin';
                    currentRepName = 'Admin';
                    currentGroup = { name: 'ADMIN', color: 'gray' };

                } else if (GRUPO_LIDERES[authenticatedEmail]) {
                     if (password !== LIDER_PASS) {
                         await signOut(auth);
                         showMessage("Contraseña de Jefe de Grupo incorrecta.", 'error');
                         return;
                    }
                    userRole = 'student';
                    currentRepName = authenticatedEmail;
                    currentGroup = GRUPO_LIDERES[authenticatedEmail];

                } else {
                    await signOut(auth); 
                    showMessage("Usuario autenticado, pero no está registrado como Jefe de Grupo o Administrador.", 'error');
                    return;
                }
            } catch (error) {
                console.error("Error de autenticación:", error.code, error.message);
                let errorMessage = "Error de credenciales. Revisa tu Correo y Contraseña.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Usuario no encontrado. Asegúrate de haber creado la cuenta en Firebase.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Contraseña incorrecta.";
                }
                showMessage(errorMessage, 'error');
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            window.location.reload(); 
        };

        onAuthStateChanged(auth, (user) => {
            // ... (código existente de onAuthStateChanged, sin cambios) ...
            if (!authReady) {
                authReady = true;
                initializeReservationListener();
            }

            const loginView = document.getElementById('login-view');
            const systemView = document.getElementById('system-view');

            if (user) {
                if (!userRole) { 
                    const email = user.email;
                    if (ADMIN_CREDENTIALS[email]) {
                        userRole = 'admin';
                        currentGroup = { name: 'ADMIN', color: 'gray' };
                        currentRepName = 'Admin';
                    } else if (GRUPO_LIDERES[email]) {
                        userRole = 'student';
                        currentGroup = GRUPO_LIDERES[email];
                        currentRepName = email;
                    } else {
                        signOut(auth); 
                        return;
                    }
                }
                userId = user.uid;
                loginView.classList.add('hidden');
                renderSystemView();
            } else {
                userId = null;
                userRole = null;
                currentGroup = null;
                currentRepName = null;
                loginView.classList.remove('hidden');
                systemView.classList.add('hidden');
            }
        });

        // --- LÓGICA DEL SISTEMA (CALENDARIO Y RESERVAS) ---

        function initializeReservationListener() {
            // ... (código existente de initializeReservationListener, sin cambios) ...
            if (!authReady) return; 
            const q = collection(db, COLLECTION_PATH);
            
            onSnapshot(q, (snapshot) => {
                reservations = [];
                snapshot.forEach((doc) => {
                    reservations.push({ id: doc.id, ...doc.data() });
                });
                
                if (document.getElementById('login-view').classList.contains('hidden')) {
                    updateCalendarView();
                }
            }, (error) => {
                console.error("Error al escuchar (reservations):", error);
                if (!document.getElementById('login-view').classList.contains('hidden')) {
                     showMessage("Error al cargar la base de datos de turnos.", 'error');
                }
            });
        }
        
        // --- RENDERIZADO DEL CALENDARIO (MODIFICADO) ---
        function renderCalendar(calendarId, weekDisplayId) {
            const calendarEl = document.getElementById(calendarId);
            const weekDisplayEl = document.getElementById(weekDisplayId);
            if (!calendarEl || !weekDisplayEl) return; 
            
            calendarEl.innerHTML = '';
            
            const days = getWeekDays(currentWeekOffset);
            
            // 1. Cabecera de Días
            const corner = document.createElement('div');
            corner.className = 'slot-header text-center';
            corner.textContent = 'Hora';
            calendarEl.appendChild(corner);
            
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'slot-header';
                dayHeader.textContent = day.toLocaleDateString('es-ES', { weekday: 'short', month: 'numeric', day: 'numeric' });
                calendarEl.appendChild(dayHeader);
            });

            // 2. Slots por Hora
            HOUR_SLOTS.forEach(slot => {
                const hourHeader = document.createElement('div');
                hourHeader.className = 'slot-header';
                hourHeader.textContent = slot.label; 
                calendarEl.appendChild(hourHeader);

                days.forEach(day => {
                    const hour = slot.data; 
                    const slotId = formatReservationId(day, hour);
                    const slotEl = document.createElement('div');
                    slotEl.dataset.slotId = slotId;
                    slotEl.dataset.date = day.toISOString().split('T')[0];
                    slotEl.dataset.hour = hour;
                    
                    const slotDateHour = new Date(day.toISOString().split('T')[0] + 'T' + hour + ':00');
                    
                    if (slotDateHour < new Date()) {
                        slotEl.textContent = 'Pasado';
                        slotEl.className = 'time-slot bg-gray-200 text-gray-500 cursor-not-allowed';
                        slotEl.onclick = null;
                    } 
                    else {
                        slotEl.className = 'time-slot slot-free text-center';
                        slotEl.textContent = 'Libre';
                        
                        if (userRole === 'student') {
                            slotEl.onclick = () => handleSlotSelection(slotEl, day, hour, 'free');
                        } else if (userRole === 'admin') {
                            slotEl.onclick = () => adminSelectSlot(slotEl, day, hour, 'free'); // <-- MODIFICADO
                        }
                    }
                    calendarEl.appendChild(slotEl);
                });
            });

            updateCalendarView();
            
            const firstDay = days[0].toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
            const lastDay = days[days.length - 1].toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
            weekDisplayEl.textContent = `${firstDay} - ${lastDay}`;
            
            // Limpiar selecciones al cambiar de semana
            if (userRole === 'student') {
                studentSelectedSlots = [];
                updateSelectionBox();
            } else {
                adminSelectedSlots = [];
                updateAdminActionBox();
            }
        }
        
        function updateCalendarView() {
            // Limpiar selecciones previas visualmente (necesario por el re-render)
            const allSlots = document.querySelectorAll('.time-slot');
            allSlots.forEach(slotEl => {
                if (slotEl.classList.contains('bg-gray-200')) return; // Ignorar 'Pasado'
                
                // Resetear a 'Libre' antes de aplicar estados
                slotEl.className = 'time-slot slot-free text-center';
                slotEl.textContent = 'Libre';
                
                // Re-asignar clicks por defecto
                const date = new Date(slotEl.dataset.date + 'T00:00:00');
                const hour = slotEl.dataset.hour;
                if (userRole === 'student') {
                    slotEl.onclick = () => handleSlotSelection(slotEl, date, hour, 'free');
                } else if (userRole === 'admin') {
                    slotEl.onclick = () => adminSelectSlot(slotEl, date, hour, 'free');
                }
            });

            // Aplicar estados desde Firestore
            reservations.forEach(res => {
                const slotElements = document.querySelectorAll(`[data-slot-id="${res.id}"]`);
                
                slotElements.forEach(slotEl => {
                    if (!slotEl) return; 
                    if (slotEl.classList.contains('bg-gray-200')) return;

                    slotEl.className = 'time-slot';
                    
                    // --- LÓGICA DE VISUALIZACIÓN DE COLOR (Modificada) ---
                    let colorName;
                    if (userRole === 'admin') {
                        // El ADMIN ve el color específico del grupo
                        colorName = res.color || 'gray';
                    } else {
                        // El ESTUDIANTE ve colores genéricos que coinciden con la leyenda
                        if (res.status === 'approved') {
                            colorName = 'red'; // Color genérico para "Reservado" (leyenda)
                        } else if (res.status === 'pending') {
                            colorName = 'yellow'; // Color genérico para "Pendiente" (leyenda)
                        } else {
                            colorName = 'default';
                        }
                    }
                    // --- FIN LÓGICA DE COLOR ---

                    const date = new Date(res.date + 'T00:00:00');
                    const hour = res.hour;
                    
                    switch (res.status) {
                        case 'approved':
                            slotEl.innerHTML = `<span class="font-bold">${res.group}</span><span class="text-xs">Reservado</span>`;
                            slotEl.classList.add(...getSlotColorClasses(colorName, 'approved'), 'cursor-not-allowed');
                            slotEl.onclick = (userRole === 'admin') ? () => adminSelectSlot(slotEl, date, hour, 'occupied') : null;
                            break;
                            
                        case 'pending':
                            slotEl.innerHTML = `<span class="font-bold">${res.group}</span><span class="text-xs">Pendiente</span>`;
                            slotEl.classList.add(...getSlotColorClasses(colorName, 'pending'));
                            
                            if (userRole === 'student' && res.representative === currentRepName) {
                                slotEl.classList.add('cursor-pointer'); 
                                slotEl.onclick = () => anularSlot(res.id); 
                            } else if (userRole === 'student') {
                                slotEl.classList.add('cursor-not-allowed');
                                slotEl.onclick = null;
                            } else { // Admin
                                slotEl.classList.add('cursor-not-allowed');
                                slotEl.onclick = () => adminSelectSlot(slotEl, date, hour, 'occupied');
                            }
                            break;
                        
                        case 'blocked':
                            slotEl.innerHTML = `<span class="font-bold">Bloqueado</span><span class="text-xs">Admin</span>`;
                            slotEl.classList.add('slot-disabled', 'bg-gray-700', 'text-white');
                            if (userRole === 'admin') {
                                slotEl.classList.add('cursor-pointer');
                                slotEl.classList.remove('cursor-not-allowed');
                                slotEl.onclick = () => adminSelectSlot(slotEl, date, hour, 'blocked');
                            } else {
                                slotEl.onclick = null;
                            }
                            break;
                            
                        case 'rejected':
                            // Se mantiene como 'Libre' (manejado por el reset inicial)
                            break;
                    }
                });
            });

            // Re-aplicar selección múltiple visual
            const selectionList = (userRole === 'admin') ? adminSelectedSlots : studentSelectedSlots;
            selectionList.forEach(slot => {
                const slotEl = document.querySelector(`[data-slot-id="${slot.id}"]`);
                if (slotEl) {
                    slotEl.classList.add('slot-selected');
                }
            });

            // Actualizar lista de admin si es admin
            if(userRole === 'admin') {
                const listEl = document.getElementById('requests-list');
                listEl.innerHTML = ''; 
                let hasPendingRequests = false;
                
                const pendingReservations = reservations
                    .filter(res => res.status === 'pending')
                    .sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)); 
                
                pendingReservations.forEach(res => {
                    renderAdminRequest(res);
                    hasPendingRequests = true;
                });
                
                if (!hasPendingRequests) {
                     listEl.innerHTML = '<p class="text-gray-500">No hay solicitudes pendientes de aprobación.</p>';
                }
            }
        }
        
        function renderAdminRequest(request) {
            const listEl = document.getElementById('requests-list');
            const requestEl = document.createElement('div');
            const dateStr = request.date; 
            
            const colorName = request.color || 'gray';
            const [bgClass, textClass, borderClass] = getSlotColorClasses(colorName, 'pending');

            requestEl.className = `p-4 border-l-4 ${borderClass} ${bgClass} rounded-lg shadow-sm flex justify-between items-center flex-wrap gap-2`;
            requestEl.innerHTML = `
                <div class="flex-grow">
                    <p class="font-bold text-lg ${textClass}">${request.group}</p>
                    <p class="text-sm ${textClass} opacity-80">Líder: ${request.representative}</p>
                    <p class="text-md font-medium ${textClass}">${dateStr} a las ${request.hour}</p>
                </div>
                <div class="space-x-2 flex-shrink-0">
                    <button onclick="updateRequestStatus('${request.id}', 'approved')" class="btn btn-success">Aprobar</button>
                    <button onclick="updateRequestStatus('${request.id}', 'rejected')" class="btn btn-danger">Rechazar</button>
                </div>
            `;
            listEl.appendChild(requestEl);
        }

        // --- LÓGICA DE SELECCIÓN MÚLTIPLE (Estudiante) ---

        function handleSlotSelection(slotEl, date, hour, currentStatus) {
            const slotId = formatReservationId(date, hour);
            const dateISO = date.toISOString().split('T')[0];
            
            if (currentStatus !== 'free') {
                return; // Solo se pueden seleccionar slots libres
            }

            const index = studentSelectedSlots.findIndex(slot => slot.id === slotId);

            if (index > -1) {
                studentSelectedSlots.splice(index, 1);
                slotEl.classList.remove('slot-selected');
            } else {
                studentSelectedSlots.push({ id: slotId, date: dateISO, hour: hour });
                slotEl.classList.add('slot-selected');
            }
            
            updateSelectionBox();
        }

        async function anularSlot(slotId) {
             if (userRole !== 'student') return;
             if (!window.confirm("¿Estás seguro de que quieres anular tu solicitud de turno pendiente?")) { return; }
             const docRef = doc(db, COLLECTION_PATH, slotId);
             try {
                // Borrar el documento es más limpio que rechazarlo
                await deleteDoc(docRef);
                showMessage("Solicitud anulada con éxito.", 'success');
             } catch (e) {
                console.error("Error al anular:", e);
                showMessage("Error al anular la solicitud.", 'error');
             }
        }
        
        function updateSelectionBox() {
            const display = document.getElementById('selected-slot-display');
            const button = document.getElementById('request-button');
            if (!display || !button) return; 
            
            if (studentSelectedSlots.length === 0) {
                display.textContent = 'Selecciona uno o más horarios libres en el calendario para solicitar un turno.';
                button.disabled = true;
                button.textContent = 'Enviar Solicitud (0 turnos)';
            } else {
                display.innerHTML = `<span class="font-bold">Turnos Seleccionados (${studentSelectedSlots.length}):</span><ul class="list-disc list-inside mt-2 text-sm">`;
                studentSelectedSlots.forEach(slot => {
                    const dayStr = new Date(slot.date + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                    display.innerHTML += `<li>${dayStr} a las ${slot.hour}</li>`;
                });
                display.innerHTML += `</ul>`;
                
                button.disabled = false;
                button.textContent = `Enviar Solicitud (${studentSelectedSlots.length} turnos)`;
            }
        }
        
        // --- LÓGICA DE ENVÍO Y ACTUALIZACIÓN ---
        
        window.submitRequest = async () => {
            if (studentSelectedSlots.length === 0) { showMessage("No has seleccionado ningún turno.", 'error'); return; }
            if (!window.confirm(`¿Estás seguro de que quieres enviar ${studentSelectedSlots.length} solicitudes de turno?`)) { return; }

            const batch = writeBatch(db);
            try {
                for (const slot of studentSelectedSlots) {
                    const slotId = slot.id;
                    const docRef = doc(db, COLLECTION_PATH, slotId);

                    const existingReservation = reservations.find(r => r.id === slotId && (r.status === 'approved' || r.status === 'pending' || r.status === 'blocked'));
                    if (existingReservation) {
                        throw new Error(`El turno ${slot.date} ${slot.hour} ya fue tomado o bloqueado.`);
                    }

                    const reservationData = {
                        id: slotId,
                        date: slot.date,
                        hour: slot.hour,
                        group: currentGroup.name,
                        color: currentGroup.color,
                        representative: currentRepName,
                        status: 'pending',
                        timestamp: serverTimestamp(),
                    };
                    
                    batch.set(docRef, reservationData);
                }
                
                await batch.commit();
                showMessage(`¡${studentSelectedSlots.length} solicitudes enviadas con éxito! Esperando aprobación.`, 'success');
                
            } catch (e) {
                console.error("Error al enviar las solicitudes en lote:", e);
                showMessage(e.message || "Error al guardar las solicitudes.", 'error');
            }

            // Limpiar selección después de enviar
            studentSelectedSlots = [];
            updateSelectionBox();
            updateCalendarView(); // Forzar re-renderizado
        };
        
        window.updateRequestStatus = async (slotId, newStatus) => {
            if (userRole !== 'admin') { return; }
            const docRef = doc(db, COLLECTION_PATH, slotId);
            try {
                if (newStatus === 'rejected') {
                    // Al rechazar, borramos el documento para que el slot vuelva a estar libre
                    await deleteDoc(docRef);
                    showMessage(`Solicitud rechazada. El slot vuelve a estar libre.`, 'info');
                } else if (newStatus === 'approved') {
                    await setDoc(docRef, { status: 'approved', timestamp: serverTimestamp() }, { merge: true });
                    showMessage(`Solicitud aprobada.`, 'success');
                }
            } catch (e) {
                console.error(`Error al actualizar el estado a ${newStatus}:`, e);
                showMessage("Error al actualizar la base de datos.", 'error');
            }
        };

        // --- FUNCIONES NUEVAS Y REACTIVADAS ---

        window.changeWeek = (offset) => {
            currentWeekOffset += offset;
            const calendarId = (userRole === 'admin') ? 'admin-calendar' : 'student-calendar';
            const weekId = (userRole === 'admin') ? 'admin-week-display' : 'student-week-display';
            renderCalendar(calendarId, weekId);
        };

        // --- NUEVA LÓGICA DE ADMIN (SELECCIÓN MÚLTIPLE) ---

        window.adminSelectSlot = (slotEl, date, hour, currentStatus) => {
            if (currentStatus === 'occupied') {
                showMessage("No se puede seleccionar un turno pendiente o aprobado.", "info");
                return;
            }
            
            const slotId = formatReservationId(date, hour);
            const dateISO = date.toISOString().split('T')[0];
            const index = adminSelectedSlots.findIndex(s => s.id === slotId);

            if (index > -1) {
                adminSelectedSlots.splice(index, 1);
                slotEl.classList.remove('slot-selected');
            } else {
                adminSelectedSlots.push({ id: slotId, date: dateISO, hour: hour, status: currentStatus });
                slotEl.classList.add('slot-selected');
            }
            updateAdminActionBox();
        };

        function updateAdminActionBox() {
            const box = document.getElementById('admin-action-box');
            if (!box) return;

            const blockBtn = document.getElementById('admin-block-btn');
            const unblockBtn = document.getElementById('admin-unblock-btn');
            const selectedCount = adminSelectedSlots.length;

            if (selectedCount === 0) {
                box.classList.add('hidden');
            } else {
                box.classList.remove('hidden');
                
                // Contar cuántos son "libres" (para bloquear) y cuántos son "bloqueados" (para desbloquear)
                const freeToBlock = adminSelectedSlots.filter(s => s.status === 'free').length;
                const blockedToUnblock = adminSelectedSlots.filter(s => s.status === 'blocked').length;

                blockBtn.textContent = `Bloquear (${freeToBlock})`;
                unblockBtn.textContent = `Desbloquear (${blockedToUnblock})`;
                
                blockBtn.disabled = freeToBlock === 0;
                unblockBtn.disabled = blockedToUnblock === 0;
            }
        }
        
        window.adminSubmitBatch = async (action) => {
            const slotsToProcess = adminSelectedSlots.filter(s => 
                (action === 'blocked' && s.status === 'free') || 
                (action === 'unblock' && s.status === 'blocked')
            );

            if (slotsToProcess.length === 0) {
                showMessage(`No hay slots seleccionados que sean ${action === 'blocked' ? 'libres' : 'bloqueados'}.`, 'info');
                return;
            }

            if (!window.confirm(`¿Estás seguro de que quieres ${action === 'blocked' ? 'BLOQUEAR' : 'DESBLOQUEAR'} ${slotsToProcess.length} turnos?`)) return;

            const batch = writeBatch(db);
            try {
                for (const slot of slotsToProcess) {
                    const docRef = doc(db, COLLECTION_PATH, slot.id);

                    if (action === 'blocked') {
                        const blockData = {
                            id: slot.id,
                            date: slot.date,
                            hour: slot.hour,
                            group: "ADMIN",
                            color: "gray",
                            representative: auth.currentUser.email,
                            status: 'blocked',
                            timestamp: serverTimestamp(),
                        };
                        batch.set(docRef, blockData);
                    } else if (action === 'unblock') {
                        batch.delete(docRef);
                    }
                }
                
                await batch.commit();
                showMessage(`¡${slotsToProcess.length} turnos actualizados con éxito!`, 'success');
                
            } catch (e) {
                console.error("Error al actualizar horarios en lote:", e);
                showMessage(e.message || "Error al guardar los cambios.", 'error');
            }

            // Limpiar selección después de enviar
            adminSelectedSlots = [];
            // Quitar el resaltado visual de todos los slots
            document.querySelectorAll('.slot-selected').forEach(el => el.classList.remove('slot-selected'));
            updateAdminActionBox();
            // El onSnapshot actualizará la vista
        };

    </script>
</body>
</html>
