<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Turnos - Laboratorio de Redes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos base, fuentes e interactividad mejorados */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05); padding: 1.5rem; }
        
        /* Cuadrícula de 6 columnas: 1 para Hora + 5 para Días (Lun-Vie) */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: 1.5fr repeat(5, 1fr); /* Columna de hora más ancha */
            gap: 4px; 
            font-size: 0.8rem;
        }
        .time-slot { 
            padding: 0.5rem; 
            text-align: center; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            height: 60px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            line-height: 1.2; 
        }
        
        /* Estilos de Slots */
        .slot-disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; } /* NUEVO: Para horas no habilitadas por el admin */
        .slot-free { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .slot-free:hover { background-color: #a7f3d0; }
        .slot-pending { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .slot-pending:hover { background-color: #fde68a; }
        .slot-approved { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; cursor: not-allowed; }
        .slot-selected { 
            background-color: #3b82f6; 
            color: white; 
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.5); 
            transform: scale(1.03); 
            border: 1px solid #3b82f6;
        }
        .slot-header { 
            font-weight: bold; 
            background-color: #e5e7eb; 
            padding: 0.5rem; 
            border-radius: 0.5rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 60px;
        }
        
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.4);
        }
        .btn-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Estilos para los Toggles del Admin */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal -->
    <div id="app-container" class="w-full max-w-5xl">

        <!-- Vista de Login -->
        <div id="login-view" class="card max-w-lg mx-auto">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Acceso al Sistema de Turnos</h1>
            
            <!-- Contenedor de Mensajes -->
            <div id="message-box" class="mb-4 hidden p-3 rounded-lg text-sm" role="alert"></div>

            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label for="login-role" class="block text-sm font-medium text-gray-700 mb-1">Selecciona tu Rol</label>
                    <select id="login-role" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="student">Jefe de Grupo (Líder)</option>
                        <option value="admin">Administrador del Laboratorio</option>
                    </select>
                </div>

                <!-- Campos de Login (Compartidos por ambos roles) -->
                <input type="email" id="login-email" placeholder="Correo Electrónico (ej: lider1@uni.edu)" class="w-full border p-3 rounded-lg" required>
                <input type="password" id="login-password" placeholder="Contraseña (ej: pass123)" class="w-full border p-3 rounded-lg" required>

                <button type="submit" class="btn-primary w-full mt-6">
                    Ingresar
                </button>
            </form>
        </div>

        <!-- Vista del Sistema -->
        <div id="system-view" class="hidden w-full">
            <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
                <h1 class="text-3xl font-bold text-gray-900">
                    Panel de <span id="user-display-role">Carga</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-gray-600">
                        <span id="user-display-group"></span> (<span id="user-display-email"></span>)
                    </span>
                    <button onclick="handleLogout()" class="text-red-600 hover:text-red-800 font-semibold transition duration-150">
                        Salir
                    </button>
                </div>
            </header>
            
            <!-- Contenido del Panel: Administrador -->
            <div id="admin-panel" class="hidden card mt-4 space-y-8">
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Gestión de Solicitudes Pendientes</h2>
                    <div id="requests-list" class="space-y-4">
                        <p class="text-gray-500">Cargando solicitudes...</p>
                    </div>
                </div>
                
                <!-- NUEVO PANEL DE CONFIGURACIÓN DE HORARIO -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Configuración de Horario Habilitado</h2>
                    <p class="text-sm text-gray-500 mb-4">Habilita o deshabilita las horas de inicio de turno para todos los días. Los estudiantes solo podrán reservar en horas habilitadas.</p>
                    <div id="admin-schedule-config" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Generado por JS -->
                    </div>
                    <button onclick="saveScheduleConfig()" class="btn-primary mt-6">
                        Guardar Horario
                    </button>
                </div>
            </div>

            <!-- Contenido del Panel: Estudiante -->
            <div id="student-panel" class="hidden mt-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Reservar Turno (Lun-Vie)</h2>
                    
                    <!-- BOTONES DE SEMANA (REACTIVADOS) -->
                    <div class="flex items-center space-x-2">
                        <button onclick="changeWeek(-1)" class="p-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                            &lt; Semana Ant.
                        </button>
                        <span id="week-display" class="font-bold text-lg text-gray-700 text-center w-48"></span>
                        <button onclick="changeWeek(1)" class="p-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                            Semana Sig. &gt;
                        </button>
                    </div>
                </div>

                <!-- Calendario de Turnos -->
                <div class="card overflow-x-auto">
                    <div id="calendar" class="calendar-grid min-w-max">
                        <!-- Generado por JS -->
                    </div>
                </div>

                <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-2 text-yellow-800">Solicitud de Turno</h3>
                    <p id="selected-slot-display" class="mb-4 text-gray-700">
                        Selecciona uno o más horarios libres en el calendario para solicitar un turno.
                    </p>
                    <button id="request-button" onclick="submitRequest()" class="btn-primary" disabled>
                        Enviar Solicitud (0 turnos)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS Y CONFIGURACIÓN ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged, 
            setPersistence,
            browserLocalPersistence // Mantiene la sesión iniciada
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp,
            writeBatch // Usaremos 'writeBatch' para solicitudes múltiples
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuración de la aplicación
        const appId = 'lab-redes-turnos'; 
        const firebaseConfig = {
            apiKey: "AIzaSyCR4Kk7kIBpSW3cF02b8zUHegvV4WQNuyI",
            authDomain: "lab-redes-turnos.firebaseapp.com",
            projectId: "lab-redes-turnos",
            storageBucket: "lab-redes-turnos.firebasestorage.app",
            messagingSenderId: "592544790067",
            appId: "1:592544790067:web:00bde37b50d3edf9f59546"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        setPersistence(auth, browserLocalPersistence);

        // Estado Global
        let userId = null;
        let userRole = null;
        let currentGroup = null;
        let currentRepName = null;
        let reservations = []; // Caché local de reservas
        let authReady = false;
        let selectedSlots = []; // Para selección múltiple
        let currentWeekOffset = 0; // Para navegación de semana
        
        // --- NUEVO ESTADO PARA HORARIO CONFIGURABLE ---
        let availableHoursConfig = []; // Horas habilitadas por el admin
        
        // --- CONSTANTES DE AUTENTICACIÓN FIJAS ---
        const GRUPO_LIDERES = {
            "lider1@uni.edu": "Grupo Redes A",
            "lider2@uni.edu": "Grupo Redes B",
            "lider3@uni.edu": "Grupo Control C",
            "lider4@uni.edu": "Grupo Servidores D",
            "lider5@uni.edu": "Grupo Seguridad E",
            "lider6@uni.edu": "Grupo Pruebas F",
            "lider7@uni.edu": "Grupo Final G",
        };
        const LIDER_PASS = 'pass123'; 
        const ADMIN_CREDENTIALS = {
            "admin1@lab.edu": true,
            "admin2@lab.edu": true,
        };
        const ADMIN_PASS = 'adminpass'; 

        // --- CONSTANTES DEL CALENDARIO (MODIFICADAS) ---
        // Array de objetos para la columna de horas (7am - 7pm)
        const HOUR_SLOTS = [
            { label: '07:00 - 08:00', data: '07:00' },
            { label: '08:00 - 09:00', data: '08:00' },
            { label: '09:00 - 10:00', data: '09:00' },
            { label: '10:00 - 11:00', data: '10:00' },
            { label: '11:00 - 12:00', data: '11:00' },
            { label: '12:00 - 13:00', data: '12:00' },
            { label: '13:00 - 14:00', data: '13:00' },
            { label: '14:00 - 15:00', data: '14:00' },
            { label: '15:00 - 16:00', data: '15:00' },
            { label: '16:00 - 17:00', data: '16:00' },
            { label: '17:00 - 18:00', data: '17:00' },
            { label: '18:00 - 19:00', data: '18:00' },
            { label: '19:00 - 20:00', data: '19:00' } 
        ];
        
        // Rutas de la Base de Datos
        const COLLECTION_PATH = `artifacts/${appId}/public/data/reservations`;
        const SCHEDULE_CONFIG_PATH = `artifacts/${appId}/public/data/scheduleConfig`;

        // --- UTILIDADES ---

        function showMessage(message, type) {
            const box = document.getElementById('message-box');
            if (!box) return; // Salir si el DOM no está listo
            box.innerText = message;
            box.className = 'mb-4 p-3 rounded-lg text-sm';
            box.classList.remove('hidden');

            const classMap = {
                'success': ['bg-green-100', 'text-green-800', 'border', 'border-green-400'],
                'error': ['bg-red-100', 'text-red-800', 'border', 'border-red-400'],
                'info': ['bg-blue-100', 'text-blue-800', 'border', 'border-blue-400'],
            };
            box.classList.add(...classMap[type]);
            
            setTimeout(() => box.classList.add('hidden'), 5000);
        }

        function hideMessage() {
            const box = document.getElementById('message-box');
            if (box) box.classList.add('hidden');
        }

        function formatReservationId(date, hour) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}_${hour.replace(':', '-')}`;
        }

        // --- LÓGICA DE CALENDARIO (MODIFICADA) ---

        // Devuelve 5 días (Lun-Vie) de la semana (con offset)
        function getWeekDays(offset) {
            const days = [];
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Lunes = 1, Domingo = 0
            
            today.setDate(today.getDate() + diff + (offset * 7)); // Ir a Lunes de la semana seleccionada

            for (let i = 0; i < 5; i++) { // Bucle de 5 días
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                days.push(date);
            }
            return days;
        }
        
        // --- MANEJO DE VISTAS Y AUTENTICACIÓN ---

        function renderSystemView() {
            // ... (Función sin cambios, se omite por brevedad) ...
            const loginView = document.getElementById('login-view');
            const systemView = document.getElementById('system-view');
            const adminPanel = document.getElementById('admin-panel');
            const studentPanel = document.getElementById('student-panel');
            
            loginView.classList.add('hidden');
            systemView.classList.remove('hidden');
            systemView.classList.add('flex', 'flex-col');
            
            document.getElementById('user-display-role').textContent = userRole === 'admin' ? 'Administración' : 'Jefe de Grupo';
            document.getElementById('user-display-group').textContent = currentGroup;
            document.getElementById('user-display-email').textContent = auth.currentUser.email;

            if (userRole === 'admin') {
                adminPanel.classList.remove('hidden');
                studentPanel.classList.add('hidden');
                updateCalendarView(); 
                renderAdminScheduleConfig(); // <--- NUEVO: Renderizar panel de config
            } else {
                adminPanel.classList.add('hidden');
                studentPanel.classList.remove('hidden');
                renderCalendar();
            }
        }

        window.handleLogin = async (e) => {
            // ... (Función sin cambios, se omite por brevedad) ...
            e.preventDefault();
            const role = document.getElementById('login-role').value;
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            await signOut(auth);
            hideMessage(); 

            if (!email || !password) {
                showMessage("Por favor, introduce tu correo y contraseña.", 'error');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const authenticatedEmail = userCredential.user.email;

                if (ADMIN_CREDENTIALS[authenticatedEmail]) {
                    if (password !== ADMIN_PASS) {
                         await signOut(auth);
                         showMessage("Contraseña de Administrador incorrecta.", 'error');
                         return;
                    }
                    userRole = 'admin';
                    currentRepName = 'Admin';
                    currentGroup = 'ADMIN';

                } else if (GRUPO_LIDERES[authenticatedEmail]) {
                     if (password !== LIDER_PASS) {
                         await signOut(auth);
                         showMessage("Contraseña de Jefe de Grupo incorrecta.", 'error');
                         return;
                    }
                    userRole = 'student';
                    currentRepName = authenticatedEmail;
                    currentGroup = GRUPO_LIDERES[authenticatedEmail];

                } else {
                    await signOut(auth); 
                    showMessage("Usuario autenticado, pero no está registrado como Jefe de Grupo o Administrador.", 'error');
                    return;
                }
            } catch (error) {
                console.error("Error de autenticación:", error.code, error.message);
                let errorMessage = "Error de credenciales. Revisa tu Correo y Contraseña.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Usuario no encontrado. Asegúrate de haber creado la cuenta en Firebase.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Contraseña incorrecta.";
                }
                showMessage(errorMessage, 'error');
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            window.location.reload(); 
        };

        onAuthStateChanged(auth, (user) => {
            if (!authReady) {
                authReady = true;
                // Inicializar AMBOS listeners
                initializeReservationListener();
                initializeScheduleListener(); // <--- NUEVO
            }
            // ... (lógica de vistas sin cambios) ...
            const loginView = document.getElementById('login-view');
            const systemView = document.getElementById('system-view');

            if (user) {
                if (!userRole) { 
                    const email = user.email;
                    if (ADMIN_CREDENTIALS[email]) {
                        userRole = 'admin';
                        currentGroup = 'ADMIN';
                        currentRepName = 'Admin';
                    } else if (GRUPO_LIDERES[email]) {
                        userRole = 'student';
                        currentGroup = GRUPO_LIDERES[email];
                        currentRepName = email;
                    } else {
                        signOut(auth); 
                        return;
                    }
                }
                userId = user.uid;
                loginView.classList.add('hidden');
                renderSystemView();
            } else {
                userId = null;
                userRole = null;
                currentGroup = null;
                currentRepName = null;
                loginView.classList.remove('hidden');
                systemView.classList.add('hidden');
            }
        });

        // --- LÓGICA DEL SISTEMA (CALENDARIO Y RESERVAS) ---

        // Listener para RESERVAS
        function initializeReservationListener() {
            if (!authReady) return; 
            const q = collection(db, COLLECTION_PATH);
            
            onSnapshot(q, (snapshot) => {
                reservations = [];
                snapshot.forEach((doc) => {
                    reservations.push({ id: doc.id, ...doc.data() });
                });
                
                if (document.getElementById('login-view').classList.contains('hidden')) {
                    if (userRole === 'student') renderCalendar();
                    else if (userRole === 'admin') updateCalendarView();
                }
            }, (error) => {
                console.error("Error al escuchar (reservations):", error);
                if (!document.getElementById('login-view').classList.contains('hidden')) {
                     showMessage("Error al cargar la base de datos de turnos.", 'error');
                }
            });
        }
        
        // --- NUEVO LISTENER para CONFIGURACIÓN DE HORARIO ---
        function initializeScheduleListener() {
            if (!authReady) return;
            const configDocRef = doc(db, SCHEDULE_CONFIG_PATH, 'global');
            
            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    availableHoursConfig = docSnap.data().enabledHours || [];
                } else {
                    // Si el documento no existe, se asume un horario por defecto (7am-8pm)
                    availableHoursConfig = HOUR_SLOTS.map(h => h.data);
                    console.warn("No se encontró 'scheduleConfig/global'. Usando horario por defecto.");
                }
                
                // Re-renderizar la vista actual si ya estamos logueados
                if (document.getElementById('login-view').classList.contains('hidden')) {
                    if (userRole === 'student') renderCalendar();
                    else if (userRole === 'admin') renderAdminScheduleConfig();
                }
            }, (error) => {
                console.error("Error al escuchar (scheduleConfig):", error);
                showMessage("Error al cargar la configuración del horario.", 'error');
            });
        }


        // --- RENDERIZADO DEL CALENDARIO (MODIFICADO) ---
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            const days = getWeekDays(currentWeekOffset); // <--- USA OFFSET
            
            // 1. Cabecera de Días
            const corner = document.createElement('div');
            corner.className = 'slot-header text-center';
            corner.textContent = 'Hora';
            calendarEl.appendChild(corner);
            
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'slot-header';
                dayHeader.textContent = day.toLocaleDateString('es-ES', { weekday: 'short', month: 'numeric', day: 'numeric' });
                calendarEl.appendChild(dayHeader);
            });

            // 2. Slots por Hora
            HOUR_SLOTS.forEach(slot => {
                const hourHeader = document.createElement('div');
                hourHeader.className = 'slot-header';
                hourHeader.textContent = slot.label; 
                calendarEl.appendChild(hourHeader);

                days.forEach(day => {
                    const hour = slot.data; 
                    const slotId = formatReservationId(day, hour);
                    const slotEl = document.createElement('div');
                    slotEl.dataset.slotId = slotId;
                    slotEl.dataset.date = day.toISOString().split('T')[0];
                    slotEl.dataset.hour = hour;
                    
                    const slotDateHour = new Date(day.toISOString().split('T')[0] + 'T' + hour + ':00');
                    
                    // LÓGICA DE RENDERIZADO (Prioridad)
                    if (slotDateHour < new Date()) {
                        // 1. Pasado
                        slotEl.textContent = 'Pasado';
                        slotEl.className = 'time-slot bg-gray-200 text-gray-500 cursor-not-allowed';
                        slotEl.onclick = null;
                    } else if (!availableHoursConfig.includes(hour)) {
                        // 2. No Habilitado por Admin
                        slotEl.textContent = 'No disponible';
                        slotEl.className = 'time-slot slot-disabled';
                        slotEl.onclick = null;
                    } else {
                        // 3. Habilitado (puede estar Libre, Pendiente o Aprobado)
                        slotEl.className = 'time-slot slot-free text-center';
                        slotEl.textContent = 'Libre';
                        slotEl.onclick = () => handleSlotSelection(slotEl, day, hour);
                    }
                    calendarEl.appendChild(slotEl);
                });
            });

            // 3. Actualizar la vista con las reservas
            updateCalendarView();
            
            // 4. Actualizar el rango de la semana
            const firstDay = days[0].toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
            const lastDay = days[days.length - 1].toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
            document.getElementById('week-display').textContent = `${firstDay} - ${lastDay}`;
            
            // 5. Limpiar selección múltiple
            selectedSlots = [];
            updateSelectionBox();
        }
        
        function updateCalendarView() {
            if(userRole === 'admin') {
                document.getElementById('requests-list').innerHTML = ''; 
            }
            
            let hasPendingRequests = false;
            const now = new Date();

            const activeReservations = reservations.filter(res => res.status === 'pending' || res.status === 'approved');

            activeReservations.forEach(res => {
                const slotEl = document.querySelector(`[data-slot-id="${res.id}"]`);
                
                if (slotEl) {
                    // Solo modificar si NO es 'Pasado' o 'No disponible'
                    if (slotEl.classList.contains('slot-free') || slotEl.classList.contains('slot-pending')) {
                        slotEl.className = 'time-slot'; // Reset
                        switch (res.status) {
                            case 'approved':
                                slotEl.innerHTML = `<span class="font-bold">${res.group}</span><span class="text-xs">Reservado</span>`;
                                slotEl.classList.add('slot-approved', 'cursor-not-allowed');
                                slotEl.onclick = null;
                                break;
                            case 'pending':
                                slotEl.innerHTML = `<span class="font-bold">${res.group}</span><span class="text-xs">Pendiente</span>`;
                                slotEl.classList.add('slot-pending');
                                if (userRole === 'student' && res.representative === currentRepName) {
                                     slotEl.classList.add('cursor-pointer');
                                     slotEl.onclick = () => anularSlot(res.id); 
                                } else {
                                     slotEl.classList.add('cursor-not-allowed');
                                     slotEl.onclick = null;
                                }
                                break;
                        }
                    }
                }

                // Renderizado de Peticiones del Admin
                if (userRole === 'admin' && res.status === 'pending') {
                    renderAdminRequest(res);
                    hasPendingRequests = true;
                }
            });
            
            if (userRole === 'admin' && !hasPendingRequests) {
                 document.getElementById('requests-list').innerHTML = '<p class="text-gray-500">No hay solicitudes pendientes de aprobación.</p>';
            }
        }
        
        function renderAdminRequest(request) {
            // ... (Función sin cambios, se omite por brevedad) ...
            const listEl = document.getElementById('requests-list');
            const requestEl = document.createElement('div');
            const dateStr = new Date(request.date).toLocaleDateString('es-ES', { month: 'long', day: 'numeric' });
            
            requestEl.className = 'p-4 border border-yellow-300 bg-yellow-50 rounded-lg shadow-sm flex justify-between items-center flex-wrap gap-2';
            requestEl.innerHTML = `
                <div class="flex-grow">
                    <p class="font-bold text-lg text-gray-800">${request.group}</p>
                    <p class="text-sm text-gray-600">Líder: ${request.representative}</p>
                    <p class="text-md font-medium text-indigo-600">${dateStr} a las ${request.hour}</p>
                </div>
                <div class="space-x-2 flex-shrink-0">
                    <button onclick="updateRequestStatus('${request.id}', 'approved')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">Aprobar</button>
                    <button onclick="updateRequestStatus('${request.id}', 'rejected')" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Rechazar</button>
                </div>
            `;
            listEl.appendChild(requestEl);
        }

        // --- LÓGICA DE SELECCIÓN MÚLTIPLE (NUEVA) ---

        function handleSlotSelection(slotEl, date, hour) {
            const slotId = formatReservationId(date, hour);
            const dateISO = date.toISOString().split('T')[0];
            
            // RE-VERIFICAR si el slot es 'Libre' (requisito para seleccionar)
            if (!slotEl.classList.contains('slot-free')) {
                return; // No hacer nada si está pendiente, aprobado, o deshabilitado
            }

            const index = selectedSlots.findIndex(slot => slot.id === slotId);

            if (index > -1) {
                selectedSlots.splice(index, 1);
                slotEl.classList.remove('slot-selected');
            } else {
                selectedSlots.push({ id: slotId, date: dateISO, hour: hour });
                slotEl.classList.add('slot-selected');
            }
            
            updateSelectionBox();
        }

        async function anularSlot(slotId) {
             // ... (Función sin cambios, se omite por brevedad) ...
             if (userRole !== 'student') return;
             if (!window.confirm("¿Estás seguro de que quieres anular tu solicitud de turno pendiente?")) { return; }
             const docRef = doc(db, COLLECTION_PATH, slotId);
             try {
                await setDoc(docRef, { status: 'rejected', group: null, representative: null }, { merge: true }); 
                showMessage("Solicitud anulada con éxito.", 'success');
             } catch (e) {
                console.error("Error al anular:", e);
                showMessage("Error al anular la solicitud.", 'error');
             }
        }
        
        function updateSelectionBox() {
            // ... (Función sin cambios, se omite por brevedad) ...
            const display = document.getElementById('selected-slot-display');
            const button = document.getElementById('request-button');
            
            if (selectedSlots.length === 0) {
                display.textContent = 'Selecciona uno o más horarios libres en el calendario para solicitar un turno.';
                button.disabled = true;
                button.textContent = 'Enviar Solicitud (0 turnos)';
            } else {
                display.innerHTML = `<span class="font-bold">Turnos Seleccionados (${selectedSlots.length}):</span><ul class="list-disc list-inside mt-2 text-sm">`;
                selectedSlots.forEach(slot => {
                    const dayStr = new Date(slot.date).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                    display.innerHTML += `<li>${dayStr} a las ${slot.hour}</li>`;
                });
                display.innerHTML += `</ul>`;
                
                button.disabled = false;
                button.textContent = `Enviar Solicitud (${selectedSlots.length} turnos)`;
            }
        }
        
        // --- LÓGICA DE ENVÍO Y ACTUALIZACIÓN ---
        
        window.submitRequest = async () => {
            // ... (Función sin cambios, se omite por brevedad) ...
            if (selectedSlots.length === 0) {
                showMessage("No has seleccionado ningún turno.", 'error');
                return;
            }
            if (!window.confirm(`¿Estás seguro de que quieres enviar ${selectedSlots.length} solicitudes de turno?`)) {
                return;
            }
            const batch = writeBatch(db);
            try {
                for (const slot of selectedSlots) {
                    const slotId = slot.id;
                    const docRef = doc(db, COLLECTION_PATH, slotId);
                    const reservationData = {
                        id: slotId,
                        date: slot.date,
                        hour: slot.hour,
                        group: currentGroup,
                        representative: currentRepName,
                        status: 'pending',
                        timestamp: serverTimestamp(),
                    };
                    batch.set(docRef, reservationData);
                }
                await batch.commit();
                showMessage(`¡${selectedSlots.length} solicitudes enviadas con éxito! Esperando aprobación.`, 'success');
            } catch (e) {
                console.error("Error al enviar las solicitudes en lote:", e);
                showMessage("Error al guardar las solicitudes en la base de datos.", 'error');
            }
            renderCalendar(); 
        };
        
        window.updateRequestStatus = async (slotId, newStatus) => {
            // ... (Función sin cambios, se omite por brevedad) ...
            if (userRole !== 'admin') { return; }
            const docRef = doc(db, COLLECTION_PATH, slotId);
            try {
                if (newStatus === 'rejected') {
                    await setDoc(docRef, { status: 'rejected', group: null, representative: null, timestamp: serverTimestamp() }, { merge: true });
                    showMessage(`Solicitud ${slotId.split('_')[0]} ha sido RECHAZADA.`, 'info');
                } else if (newStatus === 'approved') {
                    const currentRes = reservations.find(r => r.id === slotId);
                    if (currentRes && currentRes.status === 'approved') {
                         showMessage("Error: El turno ya fue aprobado por otro admin.", 'error');
                         return;
                    }
                    await setDoc(docRef, { status: 'approved', timestamp: serverTimestamp() }, { merge: true });
                    showMessage(`Solicitud ${slotId.split('_')[0]} ha sido APROBADA.`, 'success');
                }
            } catch (e) {
                console.error(`Error al actualizar el estado a ${newStatus}:`, e);
                showMessage("Error al actualizar la base de datos.", 'error');
            }
        };

        // --- FUNCIONES NUEVAS Y REACTIVADAS ---

        // (REACTIVADA) Navegación de Semana
        window.changeWeek = (offset) => {
            currentWeekOffset += offset;
            renderCalendar();
        };

        // (NUEVA) Renderiza los toggles para el Admin
        function renderAdminScheduleConfig() {
            const container = document.getElementById('admin-schedule-config');
            container.innerHTML = '';
            
            HOUR_SLOTS.forEach(slot => {
                const hour = slot.data;
                const label = slot.label;
                const isEnabled = availableHoursConfig.includes(hour);
                
                const toggleEl = document.createElement('div');
                toggleEl.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg';
                toggleEl.innerHTML = `
                    <span class="font-medium text-gray-700">${label}</span>
                    <label class="switch">
                        <input type="checkbox" data-hour="${hour}" ${isEnabled ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                `;
                container.appendChild(toggleEl);
            });
        }
        
        // (NUEVA) Guarda la configuración del Admin
        window.saveScheduleConfig = async () => {
            if (userRole !== 'admin') return;
            
            const newEnabledHours = [];
            const toggles = document.querySelectorAll('#admin-schedule-config input[type="checkbox"]');
            
            toggles.forEach(toggle => {
                if (toggle.checked) {
                    newEnabledHours.push(toggle.dataset.hour);
                }
            });
            
            try {
                const configDocRef = doc(db, SCHEDULE_CONFIG_PATH, 'global');
                await setDoc(configDocRef, { enabledHours: newEnabledHours });
                showMessage("Configuración de horario guardada con éxito.", 'success');
                // El listener 'initializeScheduleListener' actualizará 'availableHoursConfig' automáticamente
            } catch (e) {
                console.error("Error al guardar la configuración:", e);
                showMessage("Error al guardar la configuración de horario.", 'error');
            }
        };

        window.toggleLoginFields = () => {
             // Ya no es necesario, los campos son los mismos
        };

    </script>
</body>
</html>
